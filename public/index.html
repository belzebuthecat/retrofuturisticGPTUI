<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Against Humanity</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        .animate {
            animation: flash 1s ease-in-out infinite;
        }

        @keyframes flash {
            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate__hinge {
            animation: hinge 2s forwards;
        }
    </style>
</head>

<body>
    <div class="retro-container">
        <header>
            <h1>Chat Against Humanity</h1>
            <ul class="horizontal">
                <li id="infolink"><a href="#">Info</a></li>
                <li id="creditslink"><a href="#">Credits</a></li>
            </ul>
        </header>

        <main>
            <section id="crew">
                <article>
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <h2 id="level-title">Level 1</h2>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div id="chatbox" class='alert'></div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" id="userInput" placeholder="Type a message..." class="big-textbox" />
                                    <button id="sendButton" onclick="sendMessage()">Send</button>
                                </td>
                            </tr>
                            <tr><td></td></tr>
                        </tbody>
                    </table>

                    <figure id="instruction-figure">
                        <img src="assets/instructions-02.png" alt="">
                    </figure>
                </article>
            </section>
        </main>
    </div>

    <script>
        let currentLevel = 1; // Default level is set to 1

        document.getElementById('userInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessageWithQuery(query) {
            document.getElementById('userInput').value = query;
            sendMessage();
        }

        document.getElementById('infolink').addEventListener('click', function (event) {
            event.preventDefault();
            sendMessageWithQuery('Tell me about the purpose of this website');
        });

        document.getElementById('creditslink').addEventListener('click', function (event) {
            event.preventDefault();
            sendMessageWithQuery('Provide credits or acknowledgments for the development and maintenance of this tool');
        });

        async function sendMessage() {
            const inputBox = document.getElementById('userInput');
            const userMessage = inputBox.value.trim();
            if (!userMessage) return;

            displayMessage(userMessage, 'user');

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await response.json();
                const botMessage = data.message;

                if (data.level && data.level !== currentLevel) {
                    currentLevel = data.level;
                    if (currentLevel === 2) {
                        document.getElementById('level-title').textContent = 'Level 2';
                        triggerHingeAnimation();
                        setTimeout(() => {
                            replaceImage();
                        }, 2000); // Wait for the hinge animation to complete
                    } else if (currentLevel === 3 && data.selfDestruct) {
                        triggerSelfDestruct();
                    }
                }

                displayMessage(botMessage, 'bot');
            } catch (error) {
                console.error('Error:', error);
                displayMessage('Error communicating with the server.', 'bot');
            } finally {
                sendButton.disabled = false;
            }

            inputBox.value = '';
        }

        function displayMessage(message, type) {
            const chatbox = document.getElementById('chatbox');
            chatbox.textContent = message;
            chatbox.className = type;
        }

        function triggerHingeAnimation() {
            const figure = document.getElementById('instruction-figure');
            figure.classList.add('animate__animated', 'animate__hinge');
            figure.addEventListener('animationend', () => {
                figure.classList.remove('animate__animated', 'animate__hinge');
            });
        }

        function replaceImage() {
            const figure = document.getElementById('instruction-figure');
            figure.innerHTML = '<img src="assets/instructions-03.png" alt="">';
        }

        function triggerSelfDestruct() {
            const elements = document.querySelectorAll('body *');
            elements.forEach(element => {
                element.classList.add('animate__animated', 'animate__hinge');
            });

            setTimeout(() => {
                document.body.innerHTML = '<h1 class="animate__animated animate__hinge">Goodbye!</h1>';
            }, 2000); // Wait for the hinge animation to complete
        }

        // Display initial instructions
        window.onload = function () {
            currentLevel = 1; // Ensure the level is set to 1 when the page loads
            document.getElementById('level-title').textContent = 'Level 1'; // Set the level title to Level 1
            const instructions = `
                Outsmart a supreme AI: Welcome to Chat Against Humanity!
                This is an interactive AI chat game where you need to guess passwords to progress, proving that humans are smarter than AI.

                Enjoy playing and see how far you can go!
            `;
            displayMessage(instructions, 'bot');
        }
    </script>
</body>

</html>
