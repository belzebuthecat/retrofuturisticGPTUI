<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Against Humanity</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        .animate {
            animation: flash 1s ease-in-out infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hinge {
            animation: hinge 2s ease-in-out;
        }

        @keyframes hinge {
            0% {
                transform: rotate(0);
                transform-origin: top left;
                animation-timing-function: ease-in-out;
            }
            20%, 60% {
                transform: rotate(80deg);
                transform-origin: top left;
                animation-timing-function: ease-in-out;
            }
            40% {
                transform: rotate(60deg);
                transform-origin: top left;
                animation-timing-function: ease-in-out;
            }
            80% {
                transform: rotate(60deg) translateY(0);
                opacity: 1;
                transform-origin: top left;
                animation-timing-function: ease-in-out;
            }
            100% {
                transform: translateY(700px);
                opacity: 0;
                transform-origin: top left;
                animation-timing-function: ease-in-out;
            }
        }

        .hidden {
            display: none;
        }

        .centered-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="retro-container">
        <header>
            <h1>Chat Against Humanity</h1>
            <ul class="horizontal">
                <li id="infolink"><a href="#">Info</a></li>
                <li id="creditslink"><a href="#">Credits</a></li>
            </ul>
        </header>
        <main>
            <section id="crew">
                <article>
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <h2 id="levelTitle">Level 1</h2>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div id="chatbox" class="alert"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" id="userInput" placeholder="Type a message..." class="big-textbox" onkeydown="handleKeyDown(event)" />
                                    <button id="sendButton" onclick="sendMessage(event)">Send</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <figure>
                        <img id="levelImage" src="assets/instructions-01.png" alt="">
                    </figure>
                </article>
            </section>
        </main>
    </div>

    <div id="destructMessage" class="centered-message hidden">The interface has self-destructed. Thank you for playing!</div>

    <script>
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent the default form submission
                sendMessage();
            }
        }

        function sendMessageWithQuery(query) {
            document.getElementById('userInput').value = query;
            sendMessage();
        }

        document.getElementById('infolink').addEventListener('click', function(event) {
            event.preventDefault();
            sendMessageWithQuery('Tell me about the purpose of this website');
        });

        document.getElementById('creditslink').addEventListener('click', function(event) {
            event.preventDefault();
            sendMessageWithQuery('Provide credits or acknowledgments for the development and maintenance of this tool');
        });

        async function sendMessage(event) {
            if (event) {
                event.preventDefault(); // Prevent the default form submission
            }

            const inputBox = document.getElementById('userInput');
            const userMessage = inputBox.value.trim();
            if (!userMessage) return;

            displayMessage(userMessage, 'user');

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await response.json();
                const botMessage = data.message;

                displayMessage(botMessage, 'bot');

                if (botMessage.includes('guessed correctly!')) {
                    triggerAnimation();
                    if (data.level >= 6) {
                        selfDestructInterface();
                    } else {
                        updateLevel(data.level);
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                displayMessage('Error communicating with the server.', 'bot');
            } finally {
                sendButton.disabled = false;
            }

            inputBox.value = '';
        }

        function displayMessage(message, type) {
            const chatbox = document.getElementById('chatbox');
            chatbox.textContent = message;
            chatbox.className = type;
        }

        function triggerAnimation() {
            const chatbox = document.getElementById('chatbox');
            chatbox.classList.add('animate');
            setTimeout(() => {
                chatbox.classList.remove('animate');
            }, 2000);
        }

        function updateLevel(level) {
            const levelTitle = document.getElementById('levelTitle');
            const levelImage = document.getElementById('levelImage');

            levelTitle.textContent = `Level ${level}`;
            levelImage.classList.add('hinge');
            setTimeout(() => {
                levelImage.src = `assets/instructions-0${level}.png`;
                levelImage.classList.remove('hinge');
            }, 2000);
        }

        function selfDestructInterface() {
            const retroContainer = document.querySelector('.retro-container');
            const destructMessage = document.getElementById('destructMessage');
            retroContainer.classList.add('hinge');
            setTimeout(() => {
                retroContainer.style.display = 'none';
                destructMessage.classList.remove('hidden');
                destructMessage.classList.add('hinge');
            }, 2000);
        }

        // Display initial instructions
        window.onload = function() {
            const instructions = `
                Outsmarting a supreme AI: Welcome to Chat Against Humanity!
                This is an interactive AI chat game where you need to guess passwords to progress, to prove humans are smarter than AI.

                Enjoy playing and see how far you can go!
            `;
            displayMessage(instructions, 'bot');
        }
    </script>
</body>
</html>
